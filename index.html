<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Rumi Cafe Menu</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@600;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <main class="page">
    <header class="header">
      <div class="brand">
        <h1 class="title">Rumi Cafe</h1>
        <p class="subtitle">Select items • Send order on WhatsApp</p>
      </div>

      <div class="header-actions">
        <span class="chip">All prices in <b>OMR</b></span>
        <a class="chip chip-wa" href="https://wa.me/96898183175" target="_blank" rel="noopener">
          WhatsApp: +968 9818 3175
        </a>
      </div>
    </header>

    <section class="layout">
      <!-- MENU -->
      <section class="card">
        <div class="card-head">
          <h2>Menu</h2>
          <div class="search">
            <input id="searchInput" type="search" placeholder="Search items (e.g., burger, shake)..." />
          </div>
        </div>

        <div id="menuRoot" class="menu"></div>
      </section>

      <!-- ORDER -->
      <aside class="card order">
        <div class="card-head">
          <h2>Your Order</h2>
          <button id="clearBtn" class="btn btn-ghost" type="button">Clear</button>
        </div>

        <div id="orderList" class="order-list">
          <p class="muted">No items selected yet.</p>
        </div>

        <div class="totals">
          <div class="row">
            <span class="muted">Items</span>
            <b id="itemsCount">0</b>
          </div>
          <div class="row">
            <span class="muted">Total</span>
            <b><span id="totalValue">0.00</span> OMR</b>
          </div>
        </div>

        <div class="notes">
          <label for="notesInput" class="muted">Notes (optional)</label>
          <textarea id="notesInput" rows="3" placeholder="E.g., no onions, extra sauce..."></textarea>
        </div>

        <button id="whatsAppBtn" class="btn btn-primary" type="button">
          Send Order on WhatsApp
        </button>

        <p class="hint">
          Tip: After WhatsApp opens, press <b>Send</b>.
        </p>
      </aside>
    </section>
  </main>

  <script src="menu-data.js"></script>
  <script>
    // ===== Config =====
    const WHATSAPP_NUMBER = "96898183175";

    // ===== State =====
    const selected = new Map(); // key -> {name, price, qty}
    const menuRoot = document.getElementById("menuRoot");
    const orderList = document.getElementById("orderList");
    const itemsCount = document.getElementById("itemsCount");
    const totalValue = document.getElementById("totalValue");
    const notesInput = document.getElementById("notesInput");
    const searchInput = document.getElementById("searchInput");

    function money(n){
      const x = Number(n || 0);
      return x.toFixed(2);
    }
    function keyOf(sectionTitle, itemName){
      return `${sectionTitle}::${itemName}`;
    }

    // ===== Render Menu =====
    function renderMenu(filterText = ""){
      const q = filterText.trim().toLowerCase();

      let html = "";
      for (const sec of MENU.sections){
        // Filter section items
        const items = sec.items.filter(it => {
          if (!q) return true;
          return (
            (it.name || "").toLowerCase().includes(q) ||
            (it.desc || "").toLowerCase().includes(q) ||
            (sec.title || "").toLowerCase().includes(q)
          );
        });

        if (items.length === 0) continue;

        html += `
          <div class="section">
            <div class="section-title">
              <h3>${sec.title}</h3>
            </div>
            <div class="items">
              ${items.map(it => renderItem(sec.title, it)).join("")}
            </div>
          </div>
        `;
      }

      menuRoot.innerHTML = html || `<p class="muted">No results found.</p>`;
      syncMenuChecks(); // keep checkboxes in sync after rerender
    }

    function renderItem(sectionTitle, item){
      const k = keyOf(sectionTitle, item.name);
      const isSelected = selected.has(k);
      const qty = isSelected ? selected.get(k).qty : 1;

      return `
        <div class="item" data-key="${k}">
          <label class="check">
            <input type="checkbox" class="pick" ${isSelected ? "checked" : ""} />
            <span class="checkmark"></span>
          </label>

          <div class="info">
            <div class="topline">
              <div class="name">${item.name}</div>
              <div class="price">${item.price} <span class="omr">OMR</span></div>
            </div>
            ${item.desc ? `<div class="desc">${item.desc}</div>` : ""}
            <div class="controls">
              <button class="qty-btn" data-action="dec" type="button" ${isSelected ? "" : "disabled"}>-</button>
              <span class="qty">${qty}</span>
              <button class="qty-btn" data-action="inc" type="button" ${isSelected ? "" : "disabled"}>+</button>
            </div>
          </div>
        </div>
      `;
    }

    function syncMenuChecks(){
      document.querySelectorAll(".item").forEach(row => {
        const k = row.getAttribute("data-key");
        const picked = row.querySelector(".pick");
        const dec = row.querySelector('[data-action="dec"]');
        const inc = row.querySelector('[data-action="inc"]');
        const qtyEl = row.querySelector(".qty");

        const isSelected = selected.has(k);
        picked.checked = isSelected;
        dec.disabled = !isSelected;
        inc.disabled = !isSelected;

        qtyEl.textContent = isSelected ? selected.get(k).qty : 1;
      });
    }

    // ===== Order Summary =====
    function renderOrder(){
      const entries = Array.from(selected.values());

      if (entries.length === 0){
        orderList.innerHTML = `<p class="muted">No items selected yet.</p>`;
        itemsCount.textContent = "0";
        totalValue.textContent = "0.00";
        return;
      }

      let totalItems = 0;
      let total = 0;

      const lines = entries.map(e => {
        const lineTotal = Number(e.price) * e.qty;
        totalItems += e.qty;
        total += lineTotal;

        return `
          <div class="order-line">
            <div class="ol-left">
              <div class="ol-name">${e.name}</div>
              <div class="ol-meta muted">${e.qty} × ${money(e.price)} OMR</div>
            </div>
            <div class="ol-right"><b>${money(lineTotal)}</b> <span class="muted">OMR</span></div>
          </div>
        `;
      }).join("");

      orderList.innerHTML = lines;
      itemsCount.textContent = String(totalItems);
      totalValue.textContent = money(total);
    }

    // ===== Find item from MENU by key =====
    function getItemByKey(k){
      const [secTitle, itemName] = k.split("::");
      const sec = MENU.sections.find(s => s.title === secTitle);
      if (!sec) return null;
      const it = sec.items.find(i => i.name === itemName);
      if (!it) return null;
      return it;
    }

    // ===== Events =====
    menuRoot.addEventListener("click", (e) => {
      const row = e.target.closest(".item");
      if (!row) return;
      const k = row.getAttribute("data-key");
      const item = getItemByKey(k);
      if (!item) return;

      // Checkbox toggle
      if (e.target.classList.contains("pick") || e.target.closest(".check")){
        const checked = row.querySelector(".pick").checked;
        if (checked){
          selected.set(k, { name: item.name, price: item.price, qty: 1 });
        } else {
          selected.delete(k);
        }
        syncMenuChecks();
        renderOrder();
        return;
      }

      // Qty buttons
      if (e.target.classList.contains("qty-btn")){
        if (!selected.has(k)) return;
        const action = e.target.getAttribute("data-action");
        const entry = selected.get(k);

        if (action === "inc") entry.qty += 1;
        if (action === "dec") entry.qty = Math.max(1, entry.qty - 1);

        selected.set(k, entry);
        syncMenuChecks();
        renderOrder();
      }
    });

    document.getElementById("clearBtn").addEventListener("click", () => {
      selected.clear();
      notesInput.value = "";
      renderMenu(searchInput.value);
      renderOrder();
    });

    searchInput.addEventListener("input", () => {
      renderMenu(searchInput.value);
    });

    document.getElementById("whatsAppBtn").addEventListener("click", () => {
      if (selected.size === 0){
        alert("Please select at least one item.");
        return;
      }

      // Build message
      let msg = "Hello Rumi Cafe, I want to order:%0A";
      let total = 0;

      for (const e of selected.values()){
        const lineTotal = Number(e.price) * e.qty;
        total += lineTotal;
        msg += `• ${e.name} — ${e.qty} × ${money(e.price)} OMR = ${money(lineTotal)} OMR%0A`;
      }

      msg += `%0ATotal: ${money(total)} OMR`;

      const notes = notesInput.value.trim();
      if (notes){
        msg += `%0A%0ANotes: ${encodeURIComponent(notes)}`;
      }

      const url = `https://wa.me/${WHATSAPP_NUMBER}?text=${msg}`;
      window.open(url, "_blank", "noopener");
    });

    // ===== Init =====
    renderMenu("");
    renderOrder();
  </script>
</body>
</html>
